services:
  pysim:
    build: https://github.com/sportelliluciano/pysim.git
    volumes:
      - ./config:/pysim:ro
      - pysim:/tmp/pysim
    environment:
      PYSIM_CONFIG_FILE: /pysim/config.json
      PYSIM_NETWORKS_DIR: /pysim/networks

  i4a_ui:
    build: i4a-ui
    environment:
      PYSIM_URL: http://localhost:8080
    volumes:
      - pysim:/tmp/pysim
    ports:
      - 8000:8000
    depends_on:
      - pysim

  node-root:
    image: nodo:latest
    build: nodo
    volumes:
      - ./nodo:/app:ro
      - pysim:/tmp/pysim
      - ${QEMU_BUILD_PATH:-.}:/build
    working_dir: /app/src
    command: python -m nodo --root ${I4A_EXTRA_NODE_ARGS:-}
    stop_signal: SIGINT
    cap_add:
      - NET_ADMIN
    depends_on:
      - pysim

  node-home:
    image: nodo:latest
    build: nodo
    volumes:
      - ./nodo:/app:ro
      - pysim:/tmp/pysim
      - ${QEMU_BUILD_PATH:-.}:/build
    working_dir: /app/src
    network_mode: none
    command: python -m nodo ${I4A_EXTRA_NODE_ARGS:-}
    stop_signal: SIGINT
    cap_add:
      - NET_ADMIN
    deploy:
      mode: replicated
      replicas: ${I4A_HOME_NODES_COUNT:-0}
    depends_on:
      - pysim

volumes:
  pysim:
